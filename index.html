<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ­ãƒ¼ãƒ³ç‰ˆON-OFFåˆ¶å¾¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Sky Blue Tech -->
    <!-- Application Structure Plan: ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ç¶­æŒã‚’é¡Œæã«ã€ON-OFFåˆ¶å¾¡ã®åŸºæœ¬ã¨èª²é¡Œã‚’ä½“é¨“ã•ã›ã‚‹ã€‚UIã¯å°è»Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®æ§‹æˆã‚’è¸è¥²ã—ã€æ‰‹å‹•/è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã‚„ã‚²ãƒ¼ãƒ è¦ç´ ã‚’ç¶™æ‰¿ã€‚ä¸­å¿ƒçš„ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§ã®ã€Œæ¨åŠ›ONã€ãƒœã‚¿ãƒ³æ“ä½œã¨ã€è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ã§ã®ã€Œä¸æ„Ÿå¸¯ã€èª¿æ•´ã€‚ç‰©ç†ãƒ¢ãƒ‡ãƒ«ã‚’ã€Œæ¨åŠ› - é‡åŠ› - ç©ºæ°—æŠµæŠ—ã€ã«å¤‰æ›´ã—ã€ä¸Šæ˜‡(ON)ã¨è‡ªç”±è½ä¸‹(OFF)ã¨ã„ã†éå¯¾ç§°ãªåˆ¶å¾¡ã®é›£ã—ã•ã‚’å¯è¦–åŒ–ã™ã‚‹ã€‚ -->
    <!-- Visualization & Content Choices:
        - ON-OFFåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ -> Goal:åˆ¶å¾¡å‰‡ã®ç†è§£ -> Viz:HTML/CSSã«ã‚ˆã‚‹æ“¬ä¼¼ã‚³ãƒ¼ãƒ‰è¡¨ç¤º -> Interaction:ãªã— -> Justification:ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ç¶­æŒã«ãŠã‘ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªåˆ¶å¾¡ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ˜ç¢ºã«æç¤ºã™ã‚‹ãŸã‚ã€‚
        - ä¸æ„Ÿå¸¯, æ¨åŠ›, ç©ºæ°—æŠµæŠ— -> Goal:ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è‡ªç”±ãªèª¿æ•´ -> Viz:ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å…¥åŠ› -> Interaction:ãƒ‰ãƒ©ãƒƒã‚°ã§æ•°å€¤ã‚’å¤‰æ›´ã—ã€å³åº§ã«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«åæ˜  -> Justification:ç›´æ„Ÿçš„ãªæ“ä½œã§ã€ON-OFFåˆ¶å¾¡ã®æŒ™å‹•ã‚’æ±ºã‚ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã™ã‚‹ä½“é¨“ã‚’æä¾›ã™ã‚‹ãŸã‚ã€‚
        - å¿œç­”ã‚°ãƒ©ãƒ• -> Goal:ã‚·ã‚¹ãƒ†ãƒ ã®å¿œç­”ã‚’å¯è¦–åŒ– -> Viz:Chart.jsæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -> Interaction:å‹•çš„æ›´æ–° -> Justification:æ™‚é–“çµŒéã«ä¼´ã†é«˜åº¦ã®å¤‰åŒ–ã€ç›®æ¨™ã¨ã®ã‚ºãƒ¬ã€ä¸æ„Ÿå¸¯ã«ã‚ˆã‚‹æŒ¯å‹•ã®æ§˜å­ã‚’æ˜ç¢ºã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã€‚
        - ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -> Goal:ç‰©ç†çš„ãªå‹•ãã®ç›´æ„Ÿçš„ç†è§£ -> Viz:HTML/CSS/JSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -> Interaction:ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒæœŸ -> Justification:ã‚°ãƒ©ãƒ•ã®æŠ½è±¡çš„ãªå‹•ãã‚’ã€å…·ä½“çš„ãªãƒ‰ãƒ­ãƒ¼ãƒ³ã®ä¸Šä¸‹å‹•ã¨ã—ã¦è¦–è¦šåŒ–ã—ã€å­¦ç¿’åŠ¹æœã‚’é«˜ã‚ã‚‹ãŸã‚ã€‚
        - ã‚²ãƒ¼ãƒ è¦ç´ ï¼ˆã‚¹ã‚³ã‚¢å±¥æ­´ç­‰ï¼‰ -> Goal:å­¦ç¿’æ„æ¬²ã®å‘ä¸Š -> Viz:å‹•çš„ãƒ†ã‚­ã‚¹ãƒˆ -> Interaction:ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã«å¿œã˜ã¦æ›´æ–° -> Justification:æ‰‹å‹•æ“ä½œã®é›£ã—ã•ã¨è‡ªå‹•åˆ¶å¾¡ã®å„ªç§€ã•ã‚’ã€å¾—ç‚¹ã¨ã„ã†å®¢è¦³çš„æŒ‡æ¨™ã§æ¯”è¼ƒãƒ»å®Ÿæ„Ÿã•ã›ã‚‹ãŸã‚ã€‚ -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 60vh;
        }
        #drone {
            font-size: 40px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            transition: bottom 0.05s linear;
        }
        .mode-btn.active {
            border-bottom-color: rgb(59, 130, 246);
            color: rgb(59, 130, 246);
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-2xl font-bold text-blue-700">ãƒ‰ãƒ­ãƒ¼ãƒ³ç‰ˆON-OFFåˆ¶å¾¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</h1>
            <p class="text-stone-600 mt-1">ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ç¶­æŒã‚’é€šã˜ã¦ã€ON-OFFåˆ¶å¾¡ã®é›£ã—ã•ã‚’ä½“é¨“ã—ã‚ˆã†ã€‚</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">

        <section id="concept" class="mb-12">
            <h2 class="text-2xl font-semibold border-b-2 border-blue-200 pb-2 mb-4">1. ãƒ‰ãƒ­ãƒ¼ãƒ³ã®ON-OFFåˆ¶å¾¡ã¨ã¯ï¼Ÿ</h2>
            <p class="mb-6">
                ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ã‚’ä¸€å®šã«ä¿ã¤ãŸã‚ã®ã€æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªåˆ¶å¾¡æ–¹æ³•ã§ã™ã€‚ãƒ—ãƒ­ãƒšãƒ©ã®æ¨åŠ›ï¼ˆä¸Šæ˜‡ã™ã‚‹åŠ›ï¼‰ã‚’ONã«ã™ã‚‹ã‹ã€OFFï¼ˆè‡ªç”±è½ä¸‹ï¼‰ã«ã™ã‚‹ã‹ã®2æŠã§é«˜åº¦ã‚’èª¿æ•´ã—ã¾ã™ã€‚
            </p>
            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                <h3 class="text-xl font-semibold mb-4">ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ç¶­æŒãƒ­ã‚¸ãƒƒã‚¯</h3>
                <div class="bg-stone-800 text-white font-mono p-4 rounded-lg text-left text-lg">
                    <span class="text-cyan-400">if</span> (ç¾åœ¨ã®é«˜åº¦ < ç›®æ¨™é«˜åº¦) {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-yellow-400">æ¨åŠ›</span> = <span class="text-orange-400">ON</span>; // ä¸Šæ˜‡<br>
                    } <span class="text-cyan-400">else</span> {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-yellow-400">æ¨åŠ›</span> = <span class="text-orange-400">OFF</span>; // è‡ªç”±è½ä¸‹<br>
                    }
                </div>
                <p class="mt-4 text-stone-600">
                    ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ãªåˆ¶å¾¡ã«ã¯ã€ã©ã®ã‚ˆã†ãªé›£ã—ã•ãŒã‚ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚ä½“é¨“ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                </p>
            </div>
        </section>

        <section id="simulation" class="mb-12">
            <h2 class="text-2xl font-semibold border-b-2 border-blue-200 pb-2 mb-4">2. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½“é¨“ã™ã‚‹</h2>
            
            <div id="mode-selector" class="flex justify-center mb-6 border-b">
                <button id="auto-mode-btn" class="mode-btn px-6 py-3 border-b-2 border-transparent text-stone-500">è‡ªå‹•åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ‰</button>
                <button id="manual-mode-btn" class="mode-btn active px-6 py-3 border-b-2">æ‰‹å‹•åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ‰</button>
            </div>

            <p id="mode-description" class="mb-6 text-center">
                10ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ç›®æ¨™é«˜åº¦ Â±1.0m ã®ç¯„å›²ã«é•·ãç•™ã¾ã‚Œï¼
            </p>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Visuals Column -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg lg:order-2">
                     <h3 class="text-xl font-semibold mb-4">é«˜åº¦ã‚°ãƒ©ãƒ•</h3>
                    <div class="chart-container">
                        <canvas id="responseChart"></canvas>
                    </div>
                    <h3 class="text-xl font-semibold my-4">ãƒ‰ãƒ­ãƒ¼ãƒ³ã®å‹•ã</h3>
                    <div id="animation-container" class="relative w-24 h-96 mx-auto bg-sky-100 rounded-lg overflow-hidden border">
                        <div id="target-zone" class="absolute w-full bg-green-500/20"></div>
                        <div id="target-marker-line" class="absolute w-full border-t-2 border-dashed border-green-500"></div>
                        <div id="drone" style="bottom: 0;">ğŸš</div>
                        <div class="absolute bottom-1 right-1 text-xs text-stone-500">0m</div>
                        <div class="absolute top-1 right-1 text-xs text-stone-500">40m</div>
                    </div>
                    <div class="mt-2 text-lg text-center">
                        <div class="inline-block mx-4">
                            <span>é«˜åº¦: </span>
                            <span id="altitude-value" class="font-bold text-blue-600 tabular-nums w-24 inline-block text-left">0.00</span>
                            <span> m</span>
                        </div>
                        <div class="inline-block mx-4">
                            <span>åå·®: </span>
                            <span id="deviation-value" class="font-bold text-blue-600 tabular-nums w-24 inline-block text-left">+20.00</span>
                            <span> m</span>
                        </div>
                         <div class="inline-block mx-4">
                            <span>æ¨åŠ›: </span>
                            <span id="thrust-display-value" class="font-bold text-red-600 tabular-nums w-24 inline-block text-left">0.0</span>
                            <span> N</span>
                        </div>
                    </div>
                    <div id="manual-buttons-container" class="mt-4 text-center">
                         <div id="game-info" class="mb-4 p-3 bg-blue-50 rounded-lg text-center max-w-xs mx-auto">
                            <div class="flex justify-around items-center">
                                <div>
                                    <div class="text-sm text-stone-500">æ®‹ã‚Šæ™‚é–“</div>
                                    <div id="game-timer" class="text-2xl font-bold text-blue-700">10.0</div>
                                </div>
                                <div>
                                    <div class="text-sm text-stone-500">ã‚¹ã‚³ã‚¢</div>
                                    <div id="game-score" class="text-2xl font-bold text-blue-700">0</div>
                                </div>
                            </div>
                            <div id="game-result" class="mt-2 text-lg font-bold text-blue-800 h-6"></div>
                        </div>
                        <div class="flex items-center justify-center gap-4 mb-4 max-w-xs mx-auto">
                            <button id="thrust-btn" class="w-2/3 h-24 bg-stone-200 rounded-lg text-2xl active:bg-blue-500 active:text-white transition select-none font-bold">
                                æ¨åŠ› ON
                            </button>
                            <button id="run-button-manual" class="w-1/3 h-24 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                               å®Ÿè¡Œ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Controls Column -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg relative lg:order-1">
                    <h3 class="text-xl font-semibold mb-4">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</h3>
                    
                    <div id="auto-controls" class="hidden">
                         <div id="auto-game-info" class="mb-4 p-3 bg-blue-50 rounded-lg text-center">
                            <div class="text-sm text-stone-500">ã‚¹ã‚³ã‚¢</div>
                            <div id="auto-game-score" class="text-2xl font-bold text-blue-700">0</div>
                        </div>
                        <div class="mb-6 text-lg">
                           <span class="font-medium">ç›®æ¨™é«˜åº¦: </span><span class="font-bold text-blue-700">20.0 m (å›ºå®š)</span>
                        </div>
                        <div class="mb-6">
                            <label for="deadband-slider" class="block font-medium mb-1">ä¸æ„Ÿå¸¯ (ä¸­å¿ƒã‹ã‚‰ã®å¹…): <span id="deadband-value" class="font-bold text-blue-700">2.0</span> m</label>
                            <input type="range" id="deadband-slider" min="0" max="10" step="0.5" value="2.0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <button id="run-button-auto" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                           ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†å®Ÿè¡Œ
                        </button>
                        <div id="auto-score-history" class="mt-4 text-left">
                           <!-- Auto score history will be populated here -->
                        </div>
                        <div class="mt-4">
                            <button id="toggle-scenarios-btn" class="w-full text-left font-semibold text-lg text-blue-800 p-3 bg-blue-100 rounded-lg hover:bg-blue-200 transition">
                                ã‚·ãƒŠãƒªã‚ªã‚’é–‹ã â–¼
                            </button>
                            <div id="scenarios-container" class="hidden mt-4">
                                <div class="flex flex-wrap gap-4 mb-6">
                                    <button data-deadband="0" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">S1: ä¸æ„Ÿå¸¯ãªã—</button>
                                    <button data-deadband="0.5" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">S2: ä¸æ„Ÿå¸¯(ç‹­)</button>
                                    <button data-deadband="5.0" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">S3: ä¸æ„Ÿå¸¯(åºƒ)</button>
                                </div>
                                <div id="scenario-explanation" class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-sm"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="manual-controls-params">
                        <div id="manual-score-history" class="mt-4 text-left">
                           <!-- Manual score history will be populated here -->
                        </div>
                    </div>

                    <hr class="my-6">

                     <div class="mb-6">
                        <p class="font-medium">ç©ºæ°—æŠµæŠ—: <span class="font-bold text-blue-700">0.2 (å›ºå®š)</span></p>
                    </div>

                    <div class="mb-6">
                        <label for="thrust-slider" class="block font-medium mb-1">æ¨åŠ›: <span id="thrust-value" class="font-bold text-blue-700">10.0</span></label>
                        <input type="range" id="thrust-slider" min="5" max="20" step="0.5" value="10.0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <footer class="bg-white mt-12 py-6 border-t">
        <div class="container mx-auto px-6 text-center text-stone-500">
            <p>&copy; 2025 Interactive Control Simulator. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        // DOM Elements
        const deadbandSlider = document.getElementById('deadband-slider');
        const thrustSlider = document.getElementById('thrust-slider');
        const deadbandValue = document.getElementById('deadband-value');
        const thrustValue = document.getElementById('thrust-value');
        const chartCanvas = document.getElementById('responseChart');
        const droneEl = document.getElementById('drone');
        const altitudeValueEl = document.getElementById('altitude-value');
        const deviationValueEl = document.getElementById('deviation-value');
        const thrustDisplayValueEl = document.getElementById('thrust-display-value');
        
        const autoModeBtn = document.getElementById('auto-mode-btn');
        const manualModeBtn = document.getElementById('manual-mode-btn');
        const autoControls = document.getElementById('auto-controls');
        const manualControlsParams = document.getElementById('manual-controls-params');
        const modeDescription = document.getElementById('mode-description');
        const thrustBtn = document.getElementById('thrust-btn');
        
        const gameTimerEl = document.getElementById('game-timer');
        const gameScoreEl = document.getElementById('game-score');
        const gameResultEl = document.getElementById('game-result');
        const autoGameScoreEl = document.getElementById('auto-game-score');
        const targetZoneEl = document.getElementById('target-zone');
        const runButtonAuto = document.getElementById('run-button-auto');
        const runButtonManual = document.getElementById('run-button-manual');
        const toggleScenariosBtn = document.getElementById('toggle-scenarios-btn');
        const scenariosContainer = document.getElementById('scenarios-container');
        const scenarioButtons = document.querySelectorAll('.scenario-btn');
        const explanationDiv = document.getElementById('scenario-explanation');
        const manualScoreHistoryEl = document.getElementById('manual-score-history');
        const autoScoreHistoryEl = document.getElementById('auto-score-history');
        const manualButtonsContainer = document.getElementById('manual-buttons-container');

        // State variables
        let responseChart = null;
        let simulationLoopId = null;
        let currentMode = 'manual'; 
        let manualState = 0; // 0: OFF, 1: ON
        let simState = { y: 0.0, vy: 0.0, time: 0.0 }; // y for altitude
        let lastTimestamp = 0;
        
        // Game variables
        let scoreHistory = [];
        let gameTimer = 10.0;
        let timeInZone = 0.0;
        let gameActive = false;
        const gameDuration = 10.0;
        const targetAltitude = 20.0;
        const targetZoneThreshold = 1.0;

        const explanations = {
            's1': { title: 'ã‚·ãƒŠãƒªã‚ª1: ä¸æ„Ÿå¸¯ãªã—', text: 'ä¸æ„Ÿå¸¯ãŒã‚¼ãƒ­ã®å ´åˆã€ç›®æ¨™é«˜åº¦ã‚’ã‚ãšã‹ã«è¶…ãˆãŸç¬é–“ã«OFFã€ä¸‹å›ã£ãŸç¬é–“ã«ONãŒè¶…é«˜é€Ÿã§ç¹°ã‚Šè¿”ã•ã‚Œã€æ¿€ã—ãæŒ¯å‹•ã—ã¾ã™ï¼ˆãƒãƒ£ã‚¿ãƒªãƒ³ã‚°ï¼‰ã€‚' },
            's2': { title: 'ã‚·ãƒŠãƒªã‚ª2: ä¸æ„Ÿå¸¯(ç‹­)', text: 'ç‹­ã„ä¸æ„Ÿå¸¯ã‚’è¨­ã‘ã‚‹ã“ã¨ã§ãƒãƒ£ã‚¿ãƒªãƒ³ã‚°ã¯æŠ‘åˆ¶ã•ã‚Œã¾ã™ãŒã€ã¾ã ON/OFFã®é »åº¦ã¯é«˜ãã€ç´°ã‹ãæŒ¯å‹•ã—ã¾ã™ã€‚' },
            's3': { title: 'ã‚·ãƒŠãƒªã‚ª3: ä¸æ„Ÿå¸¯(åºƒ)', text: 'ä¸æ„Ÿå¸¯ã‚’åºƒãã™ã‚‹ã¨ON/OFFã®é »åº¦ã¯æ¸›ã‚Šã¾ã™ãŒã€ç›®æ¨™é«˜åº¦ã®ä¸Šä¸‹ã§å¤§ããå¤‰å‹•ã—ã€ç²¾åº¦ãŒè½ã¡ã¾ã™ã€‚' }
        };

        function switchMode(newMode) {
            currentMode = newMode;
            if (simulationLoopId) cancelAnimationFrame(simulationLoopId);
            
            if (currentMode === 'auto') {
                autoModeBtn.classList.add('active');
                manualModeBtn.classList.remove('active');
                autoControls.classList.remove('hidden');
                manualControlsParams.classList.add('hidden');
                modeDescription.innerHTML = 'æœ€é©ãª**ä¸æ„Ÿå¸¯**ã‚’è¦‹ã¤ã‘ã¦é«˜ã‚¹ã‚³ã‚¢ã‚’ç›®æŒ‡ãã†ï¼';
                manualButtonsContainer.classList.add('hidden');
            } else {
                manualModeBtn.classList.add('active');
                autoModeBtn.classList.remove('active');
                manualControlsParams.classList.remove('hidden');
                autoControls.classList.add('hidden');
                modeDescription.textContent = `${gameDuration}ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ç›®æ¨™ ${targetAltitude}m Â±${targetZoneThreshold}m ã®ç¯„å›²ã«é•·ãç•™ã¾ã‚Œï¼`;
                manualButtonsContainer.classList.remove('hidden');
            }
            updateScoreHistoryDisplay();
            updateSliderValues();
            runSimulation();
        }

        function updateSliderValues() {
            deadbandValue.textContent = parseFloat(deadbandSlider.value).toFixed(1);
            thrustValue.textContent = parseFloat(thrustSlider.value).toFixed(1);

            const maxAltitude = 40.0;
            const targetPercent = (targetAltitude / maxAltitude) * 100;
            const zoneHeightPercent = (targetZoneThreshold * 2 / maxAltitude) * 100;
            
            document.getElementById('target-marker-line').style.bottom = `${targetPercent}%`;
            targetZoneEl.style.height = `${zoneHeightPercent}%`;
            targetZoneEl.style.bottom = `calc(${targetPercent}% - ${zoneHeightPercent/2}%)`;
        }
        
        function runSimulation() {
            if (simulationLoopId) cancelAnimationFrame(simulationLoopId);
            
            simState = { y: 0.0, vy: 0.0, time: 0.0 };
            
            if (currentMode === 'auto') {
                runAutoSimulation();
            } else {
                gameTimer = gameDuration;
                timeInZone = 0.0;
                gameActive = true;
                gameResultEl.textContent = '';
                
                initializeChart(targetAltitude);
                updateUI(simState.y, 0);
                
                lastTimestamp = performance.now();
                simulationLoopId = requestAnimationFrame(manualSimulationLoop);
            }
        }
        
        function manualSimulationLoop(timestamp) {
            if (!lastTimestamp) lastTimestamp = timestamp;
            const dt = (timestamp - lastTimestamp) / 1000;
            lastTimestamp = timestamp;

            const thrust = parseFloat(thrustSlider.value);
            const m = 0.5; // mass
            const g = 9.8; // gravity
            const c = 0.2; // air resistance

            if (gameActive) {
                gameTimer -= dt;
                if (gameTimer <= 0) {
                    gameTimer = 0;
                    gameActive = false;
                    manualState = 0;
                    
                    const finalScore = Math.round((timeInZone / gameDuration) * 100);
                    scoreHistory.push({ score: finalScore, mode: 'æ‰‹å‹•' });
                    updateScoreHistoryDisplay();

                    let message = `çµæœ: ${finalScore}ç‚¹ï¼`;
                    if (finalScore > 90) message += " ã‚¨ãƒ¼ã‚¹ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆï¼";
                    else if (finalScore > 70) message += " ç´ æ™´ã‚‰ã—ã„ï¼";
                    else if (finalScore > 50) message += " ã‚ã¨å°‘ã—ï¼";
                    else message += " ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼";
                    gameResultEl.textContent = message;
                }

                if (Math.abs(targetAltitude - simState.y) <= targetZoneThreshold) timeInZone += dt;
                
                const score = Math.round((timeInZone / gameDuration) * 100);
                gameTimerEl.textContent = gameTimer.toFixed(1);
                gameScoreEl.textContent = score;
            }

            const u = manualState * thrust;
            const resistanceForce = -c * simState.vy;
            const a = (u - m * g + resistanceForce) / m;

            simState.vy += a * dt;
            simState.y += simState.vy * dt;
            if (simState.y < 0) {
                simState.y = 0;
                simState.vy = 0;
            }
            simState.time += dt;

            updateChartRealtime(simState.time, simState.y);
            updateUI(simState.y, u);
            
            if (gameActive) {
                simulationLoopId = requestAnimationFrame(manualSimulationLoop);
            }
        }
        
        function updateScoreHistoryDisplay() {
            const manualScores = scoreHistory.filter(r => r.mode === 'æ‰‹å‹•');
            manualScoreHistoryEl.innerHTML = createScoreHTML('æ‰‹å‹•', manualScores);
            const autoScores = scoreHistory.filter(r => r.mode.startsWith('è‡ªå‹•'));
            autoScoreHistoryEl.innerHTML = createScoreHTML('è‡ªå‹•', autoScores);
        }

        function createScoreHTML(mode, scores) {
            let listHTML = '';
            if (scores.length === 0) {
                listHTML = '<li class="text-stone-400">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>';
            } else {
                [...scores].reverse().slice(0, 10).forEach(record => {
                    let detail = record.mode === 'æ‰‹å‹•' ? `ã‚¹ã‚³ã‚¢: <span class="font-bold">${record.score}ç‚¹</span>` : `(${record.mode.replace('è‡ªå‹•(', '').replace(')', '')}) ã‚¹ã‚³ã‚¢: <span class="font-bold">${record.score}ç‚¹</span>`;
                    listHTML += `<li>${detail}</li>`;
                });
            }

            let averageScoreText = 'å¹³å‡ã‚¹ã‚³ã‚¢: --';
            if (scores.length > 0) {
                const totalScore = scores.reduce((sum, record) => sum + record.score, 0);
                const averageScore = totalScore / scores.length;
                averageScoreText = `å¹³å‡ã‚¹ã‚³ã‚¢: ${averageScore.toFixed(1)}ç‚¹`;
            }

            return `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-semibold">${mode}ã‚¹ã‚³ã‚¢å±¥æ­´</h4>
                    <button class="reset-scores-btn text-xs text-blue-600 hover:text-blue-800 underline" data-mode="${mode}">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <ol class="list-decimal list-inside text-sm text-stone-600 h-24 overflow-y-auto bg-stone-50 p-2 rounded">${listHTML}</ol>
                <div class="mt-2 text-center font-bold">${averageScoreText}</div>
            `;
        }

        function runAutoSimulation() {
            const deadband = parseFloat(deadbandSlider.value);
            const thrust = parseFloat(thrustSlider.value);
            const m = 0.5;
            const g = 9.8;
            const c = 0.2;
            
            let y = 0.0, vy = 0.0, state = 1; // Start by going up
            
            const dt = 0.01;
            const duration = 20.0;
            const steps = duration / dt;
            let autoTimeInZone = 0;

            const timeData = [], altitudeData = [], targetData = [], controlInputData = [];

            for (let i = 0; i <= steps; i++) {
                const currentTime = i * dt;
                timeData.push(currentTime); 
                altitudeData.push(y); 
                targetData.push(targetAltitude);

                if (y > targetAltitude + deadband) state = 0; // Thrust OFF
                else if (y < targetAltitude - deadband) state = 1; // Thrust ON

                if (Math.abs(targetAltitude - y) <= targetZoneThreshold) autoTimeInZone += dt;
                
                const u = state * thrust;
                controlInputData.push(u);
                const resistanceForce = -c * vy;
                const a = (u - m * g + resistanceForce) / m;
                vy += a * dt; 
                y += vy * dt;
                if (y < 0) { y = 0; vy = 0; }
            }
            const finalScore = Math.round((autoTimeInZone / duration) * 100);
            autoGameScoreEl.textContent = finalScore;
            scoreHistory.push({ score: finalScore, mode: `è‡ªå‹•(d:${deadband})` });
            updateScoreHistoryDisplay();
            displayAutoSimulationResults(timeData, altitudeData, targetData, controlInputData);
        }
        
        function displayAutoSimulationResults(timeData, altitudeData, targetData, controlInputData) {
            if (responseChart) responseChart.destroy();
            initializeChartWithData(timeData, altitudeData, targetData);

            let animFrameId;
            if (animFrameId) cancelAnimationFrame(animFrameId);
            const duration = timeData[timeData.length - 1] * 1000;
            let startTime = null;
            const dt = timeData[1] - timeData[0];
            
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsedTime = timestamp - startTime;
                const currentSimTime = elapsedTime / 1000;
                const dataIndex = Math.min(Math.floor(currentSimTime / dt), altitudeData.length - 1);
                updateUI(altitudeData[dataIndex], controlInputData[dataIndex]);
                if (elapsedTime < duration) animFrameId = requestAnimationFrame(animate);
            }
            animFrameId = requestAnimationFrame(animate);
        }

        function updateUI(altitude, thrust) {
            const maxAltitude = 40.0;
            const altPercent = (altitude / maxAltitude) * 100;
            droneEl.style.bottom = `calc(${altPercent}% - 20px)`;
            altitudeValueEl.textContent = altitude.toFixed(2);
            const deviation = targetAltitude - altitude;
            deviationValueEl.textContent = (deviation >= 0 ? '+' : '') + deviation.toFixed(2);
            if(thrust !== undefined) {
                 thrustDisplayValueEl.textContent = thrust.toFixed(1);
            }
        }
        
        function initializeChart(target) {
             if (responseChart) responseChart.destroy();
             const targetData = [{x: 0, y: target}, {x: gameDuration, y: target}];
             initializeChartWithData([0], [0], targetData);
             responseChart.data.datasets[0].data = []; 
        }

        function updateChartRealtime(time, altitude) {
            if (!responseChart || !responseChart.data) return;
            responseChart.data.labels.push(time);
            responseChart.data.datasets[0].data.push(altitude);
            
            const maxDataPoints = 1000;
            if (responseChart.data.labels.length > maxDataPoints) {
                responseChart.data.labels.shift();
                responseChart.data.datasets[0].data.shift();
            }
            responseChart.options.scales.x.max = gameDuration;
            responseChart.update('none');
        }

        function initializeChartWithData(time, altitude, target) {
            if(responseChart) responseChart.destroy();
            const ctx = document.getElementById('responseChart').getContext('2d');
            responseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: time,
                    datasets: [
                        { label: 'ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦', data: altitude, borderColor: 'rgb(59, 130, 246)', borderWidth: 3, pointRadius: 0 },
                        { label: 'ç›®æ¨™é«˜åº¦', data: target, borderColor: 'rgb(245, 158, 11)', borderWidth: 2, pointRadius: 0, borderDash: [5, 5] },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'æ™‚é–“ (s)' } },
                        y: { type: 'linear', title: { display: true, text: 'é«˜åº¦ (m)' }, min: 0, max: 40 }
                    },
                     plugins: { legend: { display: false } }
                }
            });
        }
        
        function updateExplanation(scenarioKey) {
            explanationDiv.innerHTML = `<p>${explanations[scenarioKey].text}</p>`;
        }
        
        // Event Listeners
        autoModeBtn.addEventListener('click', () => switchMode('auto'));
        manualModeBtn.addEventListener('click', () => switchMode('manual'));
        
        const setManualState = (state) => { if(gameActive) manualState = state; };
        thrustBtn.addEventListener('mousedown', () => setManualState(1));
        thrustBtn.addEventListener('mouseup', () => setManualState(0));
        thrustBtn.addEventListener('mouseleave', () => {if(manualState === 1) setManualState(0);});
        thrustBtn.addEventListener('touchstart', (e) => { e.preventDefault(); setManualState(1); });
        thrustBtn.addEventListener('touchend', () => setManualState(0));
        
        [deadbandSlider, thrustSlider].forEach(slider => {
            slider.addEventListener('input', updateSliderValues);
            slider.addEventListener('change', () => { if (currentMode === 'auto') runSimulation(); });
        });
        
        runButtonManual.addEventListener('click', runSimulation);
        
        document.body.addEventListener('click', function(event) {
            if (event.target.matches('.reset-scores-btn')) {
                const mode = event.target.dataset.mode;
                scoreHistory = scoreHistory.filter(r => !r.mode.startsWith(mode));
                updateScoreHistoryDisplay();
            }
        });

        toggleScenariosBtn.addEventListener('click', () => {
            const isHidden = scenariosContainer.classList.toggle('hidden');
            toggleScenariosBtn.textContent = isHidden ? 'ã‚·ãƒŠãƒªã‚ªã‚’é–‹ã â–¼' : 'ã‚·ãƒŠãƒªã‚ªã‚’é–‰ã˜ã‚‹ â–²';
        });

        scenarioButtons.forEach((button, index) => {
            button.addEventListener('click', () => {
                deadbandSlider.value = button.dataset.deadband;
                updateSliderValues();
                runSimulation();
                updateExplanation(`s${index + 1}`);
            });
        });

        window.addEventListener('load', () => {
            switchMode('manual');
        });
    </script>
</body>
</html>

